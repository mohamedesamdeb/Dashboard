<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ููุญุฉ ุงูุชุญูู ุงูุงุญุชุฑุงููุฉ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: "Tajawal", sans-serif;
    }

    .sidebar:hover {
      width: 220px;
    }

    .sidebar:hover .link-text {
      display: inline;
    }

    .input-style {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
    }

    /** Tailwind Custom Animation -->**/
    @keyframes spin-slow {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin-slow {
      animation: spin-slow 2s linear infinite;
    }

    .animate-fade-in {
      animation: fade-in 0.5s ease-out forwards;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .scrollbar-hide {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- ุงูุดุฑูุท ุงูุฌุงูุจู -->
    <aside
      class="sidebar bg-gradient-to-b from-gray-900 to-gray-800 text-white w-16 hover:w-56 transition-all duration-300 overflow-y-auto max-h-screen scrollbar-hide shadow-lg">
      <div class="flex flex-col h-full p-2 space-y-6 pt-6">
        <div class="flex items-center space-x-2 px-4 mb-4">
          <i data-lucide="layout-dashboard" class="w-6 h-6 text-blue-400"></i>
          <span class="link-text hidden font-semibold text-lg">ููุญุฉ ุงูุชุญูู</span>
        </div>

        <button onclick="loadContent('home')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-gray-800 transition text-right">
          <i data-lucide="home" class="w-7 h-7 text-yellow-400"></i>
          <span class="link-text hidden">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</span>
        </button>
        <button onclick="loadContent('attendance')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-blue-800 transition text-right">
          <i data-lucide="clock-9" class="w-7 h-7 text-blue-300"></i>
          <span class="link-text hidden">ุงูุญุถูุฑ ูุงูุงูุตุฑุงู</span>
        </button>
        <button onclick="loadContent('housing')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-green-800 transition text-right">
          <i data-lucide="cable" class="w-7 h-7 text-green-300"></i>
          <span class="link-text hidden">ุงูุชุณููู</span>
        </button>
        <button onclick="loadContent('repayment')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-purple-800 transition text-right">
          <i data-lucide="circle-dollar-sign" class="w-7 h-7 text-purple-300"></i>
          <span class="link-text hidden">Repayment</span>
        </button>
        <button onclick="loadContent('addEmployee')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-orange-900 transition text-right">
          <i data-lucide="user-plus" class="w-7 h-7 text-orange-400"></i>
          <span class="link-text hidden">ุฅุถุงูุฉ ููุธู</span>
        </button>
        <button onclick="loadContent('viewEmployees')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-teal-700 transition text-right">
          <i data-lucide="users" class="w-7 h-7 text-teal-400"></i>
          <span class="link-text hidden">ุนุฑุถ ุงูููุธููู</span>
        </button>
        <button onclick="loadContent('pgRoster')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-pink-800 transition text-right">
          <i data-lucide="calendar-days" class="w-7 h-7 text-pink-300"></i>
          <span class="link-text hidden">PG Roster</span>
        </button>
        <button onclick="loadContent('store')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-lime-800 transition text-right">
          <i data-lucide="package-plus" class="w-7 h-7 text-lime-400"></i>
          <span class="link-text hidden">ุฅุถุงูุฉ ูููุฎุฒู</span></button><br />
      </div>
    </aside>
    <!-- ูุณุงุญุฉ ุงููุญุชูู -->
    <main class="flex-1 p-4 md:p-8 bg-white rounded-none md:rounded-l-3xl shadow-inner overflow-y-auto max-h-screen">
      <div id="mainContent">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">๐ ุฃููุงู ุจูู</h1>
        <p class="text-gray-600">
          ุงุณุชุฎุฏู ุงููุงุฆูุฉ ุนูู ุงููููู ูุงุณุชุนุฑุงุถ ุงูุจุฑุงูุฌ ุงููุฎุชููุฉ.
        </p>
      </div>
    </main>
  </div>
  <!-- ุดุงุดุฉ ุชุญููู ุฒุฌุงุฌูุฉ ุงุญุชุฑุงููุฉ -->
  <div id="loaderOverlay"
    class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-md flex justify-center items-center z-50 hidden">
    <div
      class="bg-white dark:bg-gray-900 bg-opacity-70 dark:bg-opacity-80 px-8 py-6 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col items-center space-y-4 animate-fade-in">
      <!-- Animation -->
      <div class="relative w-16 h-16">
        <div class="absolute inset-0 border-4 border-blue-500 border-dashed rounded-full animate-spin-slow"></div>
        <div class="absolute inset-2 bg-blue-500 rounded-full shadow-inner animate-ping"></div>
      </div>
      <!-- Text -->
      <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">
        ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช
      </p>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        ูู ูุถูู ุงูุชุธุฑ
        <span id="countdown" class="text-blue-600 font-bold">0</span> ุซุงููุฉ...
      </p>
    </div>
  </div>
  <div id="statsPopup"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md relative animate-fade-in">
      <h2 class="text-xl font-bold text-center text-indigo-800 mb-4">
        ๐ ุฅุญุตุงุฆูุงุช ุงูููุธููู
      </h2>

      <div id="statsContent" class="space-y-4 text-center text-gray-800">
        <p>
          <strong>ุฅุฌูุงูู ุงูููุธููู:</strong> <span id="totalCount">--</span>
        </p>
        <p>
          <strong>ุนุฏุฏ ุงููุชุฒูุฌูู:</strong> <span id="marriedCount">--</span>
        </p>
        <p>
          <strong>ูุชูุณุท ุงููุฑุชุจ:</strong> <span id="avgSalary">--</span> ุฌููู
        </p>

        <canvas id="statsChart" class="mx-auto" width="200" height="200"></canvas>
      </div>

      <div class="flex justify-between mt-6">
        <button onclick="downloadStatsPDF()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          ๐ฅ ุชุญููู PDF
        </button>
        <button onclick="hideStatsPopup()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
          โ ุฅุบูุงู
        </button>
      </div>
    </div>
  </div>

  <div id="housingStatsPopup"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl relative animate-fade-in">
      <h2 class="text-xl font-bold text-center text-indigo-800 mb-4">
        ๐ ุฅุญุตุงุฆูุงุช ุงูุชุณููู
      </h2>

      <div id="housingStatsContent" class="space-y-6 text-center text-gray-800">
        <canvas id="officeChart" height="70"></canvas>
        <canvas id="hondaChart" height="70"></canvas>
        <div class="text-sm text-gray-600">
          <p>
            <strong>ุนุฏุฏ ุณุงุนุงุช ุชุดุบูู ุงููููุฏุง:</strong>
            <span id="totalHondaHours">--</span> ุณุงุนุฉ
          </p>
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button onclick="downloadHousingStatsPDF()"
          class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          ๐ฅ ุชุญููู PDF
        </button>
        <button onclick="hideHousingStats()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
          โ ุฅุบูุงู
        </button>
      </div>
    </div>
  </div>

  <div id="storePopup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md animate-fade-in relative">
      <h3 class="text-xl font-bold text-lime-700 mb-4">โ ุฅุถุงูุฉ / ุตุฑู</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">๐ ุงูุชุงุฑูุฎ</label>
          <input type="date" id="popupDate" class="input-style" required />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">๐ท ุงุณู ุงูููู</label>
          <input type="text" id="popupTechnician" class="input-style" placeholder="ุงูุชุจ ุงุณู ุงูููู" required />
        </div>

        <div>
          <label class="block text-sm text-gray-600 mb-1">๐ข ุงูููุชุจ</label>
          <select id="popupOffice" class="input-style" required>
            <option value="">ุงุฎุชุฑ ุงูููุชุจ</option>
            <option value="ุดุจุฑุง">ุดุจุฑุง</option>
            <option value="ุงููููุฏุณูู">ุงููููุฏุณูู</option>
            <option value="ุฌุณุฑ ุงูุณููุณ">ุฌุณุฑ ุงูุณููุณ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">๐ข ุงููููุฉ</label>
          <input type="number" id="popupQty" class="input-style" placeholder="ุงูุชุจ ุงููููุฉ ุจุงููุชุฑ" required />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">๐ ููุน ุงูุนูููุฉ</label>
          <select id="popupType" class="input-style" onchange="updatePopupButton()">
            <option value="ุฅุถุงูุฉ">ุฅุถุงูุฉ</option>
            <option value="ุตุฑู">ุตุฑู</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">๐ ุงูุฑูู ุงูุชุณูุณูู</label>
          <input type="text" id="popupSerial" class="input-style" placeholder="ุงูุชุจ ุงูุณูุฑูุงู" />
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button onclick="submitStoreEntry()" id="popupSubmitBtn"
          class="bg-lime-700 text-white px-4 py-2 rounded hover:bg-lime-800">
          ุชูููุฐ ุงูุฅุถุงูุฉ
        </button>
        <button onclick="closeStorePopup()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
          ุฅูุบุงุก
        </button>
      </div>
    </div>
  </div>

  <!-- ุณูุฑูุจุช ุงูุตูุญุฉ -->
  <script>
    lucide.createIcons();
    let lastDataTime = null;
    let storeDataCache = [];

    function loadContent(section) {
      const main = document.getElementById("mainContent");
      if (section === "attendance") {
        main.innerHTML = `
      <h2 class="text-2xl font-bold text-blue-800 mb-4">๐ ุฌุฏูู ุงูุญุถูุฑ ูุงูุงูุตุฑุงู</h2>
      <div class="flex flex-wrap gap-4 items-center bg-blue-50 p-4 rounded shadow mb-4">
        <input type="text" id="searchName" placeholder="ุงุจุญุซ ุจุงุณู ุงูููู..." class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" oninput="filterTable()" />
        <div class="flex items-center gap-2">
          <label for="fromDate" class="text-sm text-gray-700">ูู:</label>
          <input type="date" id="fromDate" class="px-2 py-1 border rounded" onchange="filterTable()" />
        </div>
        <div class="flex items-center gap-2">
          <label for="toDate" class="text-sm text-gray-700">ุฅูู:</label>
          <input type="date" id="toDate" class="px-2 py-1 border rounded" onchange="filterTable()" />
        </div>
        <button onclick="fetchNewAttendance()" class="ml-auto bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 flex items-center gap-2">
          <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
          <span>ุชุญุฏูุซ ุงูุจูุงูุงุช</span>
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300 rounded shadow">
          <thead class="bg-blue-200 text-blue-900">
            <tr>
              <th class="px-4 py-2 border">ุงูููุช</th>
              <th class="px-4 py-2 border">ุงูุงุณู</th>
              <th class="px-4 py-2 border">ุงูููุชุจ</th>
              <th class="px-4 py-2 border">ุงูุฅุฌุฑุงุก</th>
              <th class="px-4 py-2 border">Latitude</th>
              <th class="px-4 py-2 border">Longitude</th>
              <th class="px-4 py-2 border">ุฑุงุจุท ุงูุตูุฑุฉ</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody"></tbody>
        </table>
      </div>
    `;
        lucide.createIcons();
        fetchNewAttendance();
      } else if (section === "housing") {
        main.innerHTML = `
    <h2 class="text-2xl font-bold text-green-800 mb-4">๐ฆ ุฌุฏูู ุงูุชุณููู</h2>
    <div class="flex flex-wrap gap-4 items-center bg-blue-50 p-4 rounded shadow mb-4">
        <input type="text" id="searchName" placeholder="ุงุจุญุซ ุจุงุณู ุงูููู..." class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" oninput="filterTable()" />
  <input type="text" id="searchSiteID" placeholder="ุงุจุญุซ ุจุฑูู ุงููููุน..." class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" oninput="filterTable()" />
        <button onclick="fetchHousingData()" class="ml-auto bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 flex items-center gap-2">
         <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
          <span>ุชุญุฏูุซ ุงูุจูุงูุงุช</span>
        </button>

        <button onclick="exportHousingToExcel()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2">
  <i data-lucide="download" class="w-4 h-4"></i>
  <span>ุชุญููู ุงูุจูุงูุงุช</span>
</button>



        <button onclick="showHousingStats()"
        class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 flex items-center gap-2">
  <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
  <span>ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช</span>
</button>

      </div>
    <div class="overflow-auto rounded shadow border border-gray-300">
      <table class="min-w-full bg-white text-center border border-gray-200">
        <thead id="housingTableHead" class="bg-green-100 text-green-800 font-bold">
          <tr>
              <th class="px-4 py-2 border">Resource Name</th>
              <th class="px-4 py-2 border">PG S.N.</th>
              <th class="px-4 py-2 border">Category</th>
              <th class="px-4 py-2 border">Office</th>
              <th class="px-4 py-2 border">Site ID</th>
              <th class="px-4 py-2 border">Date in</th>
              <th class="px-4 py-2 border">Time in</th>
              <th class="px-4 py-2 border">Date out</th>
               <th class="px-4 py-2 border">Time out</th>
                 <th class="px-4 py-2 border">TT</th>
                  <th class="px-4 py-2 border">Fuel spear</th>
            </tr>
          </thead>
        <tbody id="housingTableBody"></tbody>
      </table>
    </div>
  `;
        lucide.createIcons();
        fetchHousingData();
      } else if (section === "repayment") {
        main.innerHTML = `
      <h2 class="text-2xl font-bold text-purple-800 mb-2">๐ธ ุตูุญุฉ Repayment</h2>
      <p class="text-gray-700">ุงูุชูุงุท ุงูุตูุฑ ูุฑูุน ุงูุจูุงูุงุช ููุง.</p>
    `;
      } else if (section === "home") {
        main.innerHTML = `
    <section class="space-y-8">
      <!-- ูุฑูุช ุงูุฅุญุตุงุฆูุงุช -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center mt-6">
        <div class="bg-white p-4 rounded-xl shadow border text-teal-700">
          <div class="text-3xl font-bold" id="employeeCount">--</div>
          <div class="mt-2">๐ฅ ุนุฏุฏ ุงูููุธููู</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow border text-orange-700 text-right">
  <div class="text-lg font-bold mb-2">๐ข ุชูุฒูุน ุงูููุธููู ุญุณุจ ุงูููุงุชุจ</div>
  <ul id="officeList" class="space-y-1 text-sm">
    <!-- ููููุฃู ุฏููุงูููููุง -->
  </ul>
</div>

        <div class="bg-white p-4 rounded-xl shadow border text-indigo-700">
          <div class="text-3xl font-bold" id="housingCount">--</div>
          <div class="mt-2">๐ ุนุฏุฏ ุญุงูุงุช ุงูุชุณููู </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex items-center justify-between">
  <div>
    <h3 class="text-sm font-medium text-gray-500">ุญุงูุงุช ุงูุชุณููู ุงููุดุทุฉ</h3>
    <p id="openHousingCount" class="text-xl font-semibold text-gray-800 mt-1">--</p>
    <ul id="openHousingList" class="mt-2 text-xs text-gray-600 space-y-1"></ul>
  </div>
  <div class="text-green-500 bg-green-100 p-2 rounded-full">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6h6v6m2 4H7a2 2 0 01-2-2V7a2 2 0 012-2h5l2 2h5a2 2 0 012 2v10a2 2 0 01-2 2z" />
    </svg>
  </div>
</div>

<div class="bg-white p-4 rounded-xl shadow border text-lime-700 text-right">
  <div class="text-lg font-bold mb-2">๐ช ุฃุฑุตุฏุฉ ุงููุฎุฒู ุญุณุจ ุงูููุงุชุจ</div>
  <ul class="text-sm space-y-1">
    <li>ุดุจุฑุง: <strong id="balanceShubraHome">--</strong> ูุชุฑ</li>
    <li>ุงููููุฏุณูู: <strong id="balanceMohandessinHome">--</strong> ูุชุฑ</li>
    <li>ุฌุณุฑ ุงูุณููุณ: <strong id="balanceGesrHome">--</strong> ูุชุฑ</li>
  </ul>
</div>



        <div class="bg-white p-4 rounded-xl shadow border text-gray-700">
          <div class="text-xl font-semibold" id="lastUpdate">--</div>
          <div class="mt-2">๐ ุขุฎุฑ ุชุญุฏูุซ</div>
        </div>
      </div>

      <!-- ุงููุฎุทุทุงุช -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
        <div class="bg-white p-4 rounded-xl shadow border">
          <h3 class="font-bold text-teal-700 mb-2">๐ ุงุณุชุฎุฏุงู ุงููููุฏุง</h3>
          <canvas id="homeHondaChart" height="200"></canvas>
        </div>
        <div class="bg-white p-4 rounded-xl shadow border">
          <h3 class="font-bold text-indigo-700 mb-2">๐ข ุชูุฒูุน ุงูุชุณููู ุญุณุจ ุงูููุงุชุจ</h3>
          <canvas id="homeOfficeChart" height="200"></canvas>
        </div>
      </div>

      <!-- ุชูุฒูุน ุงูููุธููู -->
      <div class="bg-white p-4 rounded-xl shadow border mt-6">
        <h3 class="font-bold text-gray-700 mb-2">๐จโ๐ผ ุชูุฒูุน ุงูููุธููู ุญุณุจ ุงููุธููุฉ</h3>
        <canvas id="homeJobChart" height="200"></canvas>
      </div>
    
  `;

        loadHomeStats();
      } else if (section === "addEmployee") {
        main.innerHTML = `
    <h2 class="text-2xl font-bold text-orange-800 mb-4">๐ ุฅุถุงูุฉ ููุธู</h2>
    <form method="POST" action="https://script.google.com/macros/s/AKfycbyIkawBofCnNpqwyk8t1VP3ryipZ-8N3rUeyHfp7khBIHSI8O7b6lVZF9kLtDKY8dY5/exec" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" name="name" placeholder="ุงุณู ุงูููุธู" class="input-style" required />
        <input type="text" name="nationalId" placeholder="ุงูุฑูู ุงููููู" class="input-style" />
        <input type="text" name="address" placeholder="ุงูุนููุงู" class="input-style" />
        <input type="text" name="mobile" placeholder="ุฑูู ุงูููุจุงูู" class="input-style" />
        <input type="text" name="jobTitle" placeholder="ุงููุธููุฉ" class="input-style" />
        <input type="text" name="project" placeholder="ุงููุดุฑูุน" class="input-style" />
        <select name="office" class="input-style">
          <option value="">ุงุฎุชุฑ ุงูููุชุจ</option>
          <option value="ุดุจุฑุง">ุดุจุฑุง</option>
          <option value="ุฌุณุฑ ุงูุณููุณ">ุฌุณุฑ ุงูุณููุณ</option>
          <option value="ุงููููุฏุณูู">ุงููููุฏุณูู</option>
        </select>

        <div class="flex flex-col">
  <select name="status" class="input-style">
    <option value="">ุงุฎุชุฑ ุงูุญุงูุฉ</option>
    <option value="ุฃุนุฒุจ">ุฃุนุฒุจ</option>
    <option value="ูุชุฒูุฌ">ูุชุฒูุฌ</option>
    <option value="ูุทูู">ูุทูู</option>
    <option value="ุฃุฑูู">ุฃุฑูู</option>
  </select>
</div>
        <div class="flex flex-col">
  <label class="text-sm text-gray-700 mb-1">๐ ุชุงุฑูุฎ ุงููููุงุฏ</label>
  <input type="date" name="birthDate" class="input-style" />
</div>

<div class="flex flex-col">
  <label class="text-sm text-gray-700 mb-1">๐๏ธ ุชุงุฑูุฎ ุงูุชุนููู</label>
  <input type="date" name="hireDate" class="input-style" />
</div>

        

        <input type="number" name="salary" placeholder="ุงููุฑุชุจ ุจุงูุฌููู" class="input-style" />
      </div>
      <button type="submit" class="bg-orange-600 text-white px-6 py-3 rounded shadow hover:bg-orange-700">
        โ ุฅุถุงูุฉ ุงูููุธู
      </button>
    </form>
  `;
      } else if (section === "viewEmployees") {
        main.innerHTML = `
    <h2 class="text-2xl font-bold text-teal-800 mb-4">๐จโ๐ผ ูุงุฆูุฉ ุงูููุธููู</h2>

<!-- ุฃุฏูุงุช ุงูุจุญุซ -->
<div class="flex flex-wrap gap-4 items-center bg-teal-50 p-4 rounded shadow mb-4">
  <input type="text" id="searchEmployee" placeholder="ุงุจุญุซ ุจุงุณู ุงูููุธู..." 
         class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" 
         oninput="filterEmployees()" />

  <button onclick="fetchEmployeeData()" 
          class="bg-teal-600 text-white px-4 py-2 rounded shadow hover:bg-teal-700 flex items-center gap-2">
    <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
    <span>ุชุญุฏูุซ ุงูุจูุงูุงุช</span>
  </button>

  <button onclick="exportEmployeesToExcel()" 
          class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2">
    <i data-lucide="download" class="w-4 h-4"></i>
    <span>ุชุญููู Excel</span>
  </button>
  <button onclick="showStatsPopup()"
        class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 flex items-center gap-2">
  <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
  <span>ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช</span>
</button>

</div>

      <table class="min-w-full bg-white text-center border border-gray-200">
        <thead class="bg-teal-100 text-teal-800 font-bold">
          <tr>
            <th class="px-4 py-2 border">HireDate</th>
            <th class="px-4 py-2 border">Name</th>
            <th class="px-4 py-2 border">NationalId</th>
            <th class="px-4 py-2 border">Address</th>
            <th class="px-4 py-2 border">Mobile</th>
            <th class="px-4 py-2 border">JobTitle</th>
            <th class="px-4 py-2 border">Project</th>
            <th class="px-4 py-2 border">Office</th>
            <th class="px-4 py-2 border">Status</th>
            <th class="px-4 py-2 border">Salary</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody"></tbody>
      </table>
    </div>
  `;
        lucide.createIcons();
        fetchEmployeeData();
      } else if (section === "pgRoster") {
        const main = document.getElementById("mainContent");
        const today = new Date();
        const dateStr = today.toISOString().split("T")[0];
        const weekdayName = today.toLocaleDateString("ar-EG", {
          weekday: "long",
        });

        main.innerHTML = `
    <h2 class="text-2xl font-bold text-pink-700 mb-6 text-center">๐ PG Roster</h2>
    <div class="flex flex-col md:flex-row justify-center items-center gap-6">
      <button onclick="showPgRosterCar()" class="bg-blue-600 text-white p-6 rounded-xl shadow hover:bg-blue-700 text-center w-60">
        <div class="text-lg font-bold mb-2">๐ PG Roster Car</div>
        <div class="text-sm text-white/80">${dateStr}</div>
      </button>
      
    </div>
    <div id="pgRosterWrapper" class="mt-10 relative hidden">
  <!-- ุฃุฒุฑุงุฑ ุงููุณุฎ ูุงูุฅุบูุงู -->
  <div class="absolute top-2 left-2 flex gap-2 z-10">
    <button onclick="copyPgRosterText()"
      class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded flex items-center gap-1 shadow">
      <i data-lucide="copy" class="w-4 h-4"></i> ูุณุฎ
    </button>
    <button onclick="hidePgRosterOutput()"
      class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded flex items-center gap-1 shadow">
      <i data-lucide="x" class="w-4 h-4"></i> ุฅุบูุงู
    </button>
  </div>

  <!-- ูุญุชูู ุงููุต -->
  <div id="pgRosterOutput"
    class="whitespace-pre-wrap font-mono text-sm bg-gray-100 p-4 pt-14 rounded-xl shadow text-gray-800">
    <!-- ุจูุชู ููุคู ุฏููุงูููููุง -->
  </div>
</div>

</div>


  `;
        lucide.createIcons();
      } else if (section === "store") {
        main.innerHTML = `
  <h2 class="text-2xl font-bold text-lime-700 mb-6">๐ฆ ุงููุฎุฒู</h2>

  <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
   <div class="flex flex-wrap justify-end gap-2 mb-4">
  <button onclick="openStorePopup()" class="bg-lime-700 hover:bg-lime-800 text-white px-6 py-2 rounded shadow text-sm">
    โ ุฅุถุงูุฉ / ุตุฑู ุฌุฏูุฏ
  </button>

  <button onclick="exportAllStoreData()" class="bg-blue-800 hover:bg-blue-900 text-white px-6 py-2 rounded shadow text-sm">
  ๐ฆ ุชุตุฏูุฑ ูู ุงูุจูุงูุงุช
</button>

</div>

    

    <div class="flex flex-wrap gap-4 text-sm">
      <span class="bg-white border px-4 py-2 rounded shadow">๐ข ุดุจุฑุง: <strong id="balanceShubra">--</strong> ูุชุฑ</span>
      <span class="bg-white border px-4 py-2 rounded shadow">๐ข ุงููููุฏุณูู: <strong id="balanceMohandessin">--</strong> ูุชุฑ</span>
      <span class="bg-white border px-4 py-2 rounded shadow">๐ข ุฌุณุฑ ุงูุณููุณ: <strong id="balanceGesr">--</strong> ูุชุฑ</span>
    </div>
  </div>

  <div class="flex flex-wrap gap-4 justify-end items-center mb-4">
  <div>
    <label class="mr-2 text-sm font-semibold">ููุน ุงูุนูููุฉ:</label>
    <select id="filterType" class="border rounded px-2 py-1 text-sm">
      <option value="">ุงููู</option>
      <option value="ุฅุถุงูุฉ">ุฅุถุงูุฉ</option>
      <option value="ุตุฑู">ุตุฑู</option>
    </select>
  </div>
  <div>
    <label class="mr-2 text-sm font-semibold">ุงูููุชุจ:</label>
    <select id="filterOffice" class="border rounded px-2 py-1 text-sm">
      <option value="">ุงููู</option>
      <option value="ุดุจุฑุง">ุดุจุฑุง</option>
      <option value="ุงููููุฏุณูู">ุงููููุฏุณูู</option>
      <option value="ุฌุณุฑ ุงูุณููุณ">ุฌุณุฑ ุงูุณููุณ</option>
    </select>
  </div>
</div>



  <div id="storeTableWrapper" class="overflow-x-auto bg-white border rounded shadow">
    <table class="min-w-full text-center">
      <thead class="bg-lime-100 text-lime-800">
  <tr>
    <th class="px-4 py-2 border">๐ ุงูุชุงุฑูุฎ</th>
    <th class="px-4 py-2 border">๐ท ุงุณู ุงูููู</th> <!-- โ ุงูุนููุฏ ุงูุฌุฏูุฏ -->
    <th class="px-4 py-2 border">๐ข ุงูููุชุจ</th>
    <th class="px-4 py-2 border">๐ข ุงููููุฉ</th>
    <th class="px-4 py-2 border">๐ ููุน ุงูุนูููุฉ</th>
    <th class="px-4 py-2 border">๐ ุงูุฑูู ุงูุชุณูุณูู</th>
    <th class="px-4 py-2 border">๐ฅ ุงูุฅุถุงูุฉ</th>
    <th class="px-4 py-2 border">๐ค ุงูุตุฑู</th>
  </tr>
</thead>

      <tbody id="storeTableBody">
        <!-- ููุชููุฃ ุฏููุงูููููุง -->
      </tbody>
    </table>
  </div>
`;
        lucide.createIcons();
        fetchStoreData(); // ุชุญููู ุงูุจูุงูุงุช ูู ุงูุดูุช ููุง ูููู ูุงุญููุง
        document
          .getElementById("filterType")
          .addEventListener("change", renderFilteredStoreData);
        document
          .getElementById("filterOffice")
          .addEventListener("change", renderFilteredStoreData);
      }
    }
    function filterBySiteID() {
      const input = document
        .getElementById("searchSiteID")
        .value.trim()
        .toLowerCase();
      const rows = document.querySelectorAll("#housingTableBody tr");
      rows.forEach((row) => {
        const siteID = row.cells[5]?.textContent.toLowerCase() || "";
        if (siteID.includes(input)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }
    function fetchNewAttendance() {
      const overlay = document.getElementById("loaderOverlay");
      const countdownText = document.getElementById("countdown");
      overlay.classList.remove("hidden");
      let seconds = 0;
      countdownText.textContent = seconds;
      const timer = setInterval(() => {
        seconds++;
        countdownText.textContent = seconds;
      }, 1000);
      fetch(
        "https://script.google.com/macros/s/AKfycby5QdbFnpkhnBFkl5el6B2rflE1HcCHTMzV2hERMhbll4veiAESm4ElsQf7Bey3sDzUAQ/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const tableBody = document.getElementById("attendanceTableBody");
          tableBody.innerHTML = "";
          data.forEach((row) => {
            const tr = document.createElement("tr");
            tr.className = "text-center hover:bg-gray-100 transition";
            tr.innerHTML = `
          <td class="px-4 py-2 border">${row["ุงูููุช"]}</td>
          <td class="px-4 py-2 border">${row["ุงูุงุณู"]}</td>
          <td class="px-4 py-2 border">${row["ุงูููุชุจ"]}</td>
          <td class="px-4 py-2 border font-bold ${row["ุงูุฅุฌุฑุงุก"] === "ุฏุฎูู" ? "text-green-600" : "text-red-600"
              }">${row["ุงูุฅุฌุฑุงุก"]}</td>
          <td class="px-4 py-2 border">${row["ุฎุท ุงูุนุฑุถ (Latitude)"]}</td>
          <td class="px-4 py-2 border">${row["ุฎุท ุงูุทูู (Longitude)"]}</td>
          <td class="px-4 py-2 border"><a href="${row["ุงูุตูุฑุฉ (ุฑุงุจุท)"]
              }" target="_blank" class="text-blue-500 underline">ุนุฑุถ</a></td>
        `;
            tableBody.appendChild(tr);
          });
          lucide.createIcons();
        })
        .catch((err) => {
          console.error(err);
          alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช.");
        })
        .finally(() => {
          clearInterval(timer);
          overlay.classList.add("hidden");
        });
    }
    function formatCustomDateTimeISO(dateStr, timeStr) {
      try {
        const dateObj = new Date(dateStr);
        const timeObj = new Date(timeStr);

        const final = new Date(
          dateObj.getFullYear(),
          dateObj.getMonth(),
          dateObj.getDate(),
          timeObj.getHours(),
          timeObj.getMinutes()
        );
        return final.toLocaleString("ar-EG", {
          timeZone: "Africa/Cairo",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
      } catch (e) {
        return `${dateStr} | ${timeStr}`;
      }
    }
    function fetchHousingData() {
      const overlay = document.getElementById("loaderOverlay");
      const countdownText = document.getElementById("countdown");

      overlay.classList.remove("hidden");
      let seconds = 0;
      countdownText.textContent = seconds;
      const timer = setInterval(() => {
        seconds++;
        countdownText.textContent = seconds;
      }, 1000);

      fetch(
        "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const grouped = {};

          data.forEach((row) => {
            const name = row["Resource Name"]?.trim();
            const site = row["Site ID"]?.trim();
            const sn = row["PG S.N."]?.trim();
            const type = row["ููุน ุงูุชุณููู"]?.trim();
            const date = row["Date"];
            const time = row["Time "] || "";
            const key = `${name}_${site}_${sn}`;

            if (!grouped[key]) {
              grouped[key] = {
                name,
                sn,
                category: row["Category"],
                office: row["Office"],
                site,
                fuel: row["Fuel spear"],
                tt: row["Transmission Only"],
                dateIn: "",
                timeIn: "",
                dateOut: "",
                timeOut: "",
              };
            }

            if (type.includes("ุจุฏุงูุฉ")) {
              grouped[key].dateIn = date;
              grouped[key].timeIn = time;
            } else if (type.includes("ููุงูุฉ")) {
              grouped[key].dateOut = date;
              grouped[key].timeOut = time;
            }
          });

          const tableBody = document.getElementById("housingTableBody");
          tableBody.innerHTML = "";

          Object.values(grouped).forEach((item) => {
            let hours = "";
            try {
              const start = new Date(`${item.dateIn}T${item.timeIn}`);
              const end = new Date(`${item.dateOut}T${item.timeOut}`);
              const diff = (end - start) / 1000 / 3600;
              if (diff > 0 && diff < 24) hours = diff.toFixed(2);
            } catch { }

            const tr = document.createElement("tr");
            tr.className = "text-center hover:bg-gray-100 transition";
            tr.innerHTML = `
          <td class="px-4 py-2 border">${item.name || ""}</td>
          <td class="px-4 py-2 border">${item.sn || ""}</td>
          <td class="px-4 py-2 border">${item.category || ""}</td>
          <td class="px-4 py-2 border">${item.office || ""}</td>
          <td class="px-4 py-2 border">${item.site || ""}</td>
          <td class="px-4 py-2 border">${formatDateForCSV(item.dateIn)}</td>
          <td class="px-4 py-2 border">${extractTimeOnly(item.timeIn)}</td>
          <td class="px-4 py-2 border">${formatDateForCSV(item.dateOut)}</td>
          <td class="px-4 py-2 border">${extractTimeOnly(item.timeOut)}</td>
          <td class="px-4 py-2 border">${item.tt || ""}</td>
          <td class="px-4 py-2 border">${item.fuel || ""}</td>
        `;
            tableBody.appendChild(tr);
          });
        })
        .catch((err) => {
          console.error(err);
          alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงูุชุณููู.");
        })
        .finally(() => {
          clearInterval(timer);
          overlay.classList.add("hidden");
        });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr; // ูู ุงูุชุงุฑูุฎ ูุด ุตุงูุญ

      // ุชูุณูู ุงูุชุงุฑูุฎ ูุงูููุช ุญุณุจ ุชูููุช ูุตุฑ (GMT+3)
      return date.toLocaleString("ar-EG", {
        timeZone: "Africa/Cairo",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    function filterTable() {
      const searchName =
        document.getElementById("searchName")?.value.trim() || "";
      const searchSiteID =
        document.getElementById("searchSiteID")?.value.trim() || "";
      const fromDate = document.getElementById("fromDate")?.value || "";
      const toDate = document.getElementById("toDate")?.value || "";
      // ุฌุฏูู ุงูุชุณููู
      const housingRows = document.querySelectorAll("#housingTableBody tr");
      housingRows.forEach((row) => {
        const name = row.querySelector("td:nth-child(1)")?.textContent || "";
        const siteID =
          row.querySelector("td:nth-child(5)")?.textContent || "";
        const date = row.querySelector("td:nth-child(7)")?.textContent || "";
        let show = true;
        if (searchName && !name.includes(searchName)) show = false;
        if (searchSiteID && !siteID.includes(searchSiteID)) show = false;
        if (fromDate && date < fromDate) show = false;
        if (toDate && date > toDate) show = false;
        row.style.display = show ? "" : "none";
      });
      // ุฌุฏูู ุงูุญุถูุฑ
      const attendanceRows = document.querySelectorAll(
        "#attendanceTableBody tr"
      );
      attendanceRows.forEach((row) => {
        const name = row.querySelector("td:nth-child(2)")?.textContent || "";
        const dateTimeText =
          row.querySelector("td:nth-child(1)")?.textContent || "";
        const dateObj = new Date(dateTimeText.replace(",", ""));
        let show = true;
        if (searchName && !name.includes(searchName)) show = false;
        // ููุชุฑ ุงูุชุงุฑูุฎ ุจุนุฏ ุงูุชุญููู
        if (!isNaN(dateObj)) {
          if (fromDate && dateObj < new Date(fromDate)) show = false;
          if (toDate && dateObj > new Date(toDate)) show = false;
        }
        row.style.display = show ? "" : "none";
      });
    }
    function formatDateOnly(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      return date.toLocaleDateString("ar-EG", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });
    }
    function formatTimeOnly(timeStr) {
      if (!timeStr) return "";
      const date = new Date("1970-01-01T" + timeStr);
      if (isNaN(date)) return timeStr;
      return date.toLocaleTimeString("ar-EG", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    function previewImage() {
      const input = document.getElementById("photo");
      const preview = document.getElementById("preview");
      const plusIcon = document.getElementById("plusIcon");
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.classList.remove("hidden");
          plusIcon.classList.add("hidden");
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function fetchEmployeeData() {
      const overlay = document.getElementById("loaderOverlay");
      const countdownText = document.getElementById("countdown");

      // โ ุนุฑุถ ุดุงุดุฉ ุงูุชุญููู
      overlay.classList.remove("hidden");

      let seconds = 0;
      countdownText.textContent = seconds;
      const timer = setInterval(() => {
        seconds++;
        countdownText.textContent = seconds;
      }, 1000);

      fetch(
        "https://script.google.com/macros/s/AKfycbwW05ThHhLzFFqq3mZ-hvayRoHlGA7ESpd0ysT1lVPY3nukqr6S5f1WdyHWobGF3c5p/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const tableBody = document.getElementById("employeeTableBody");
          tableBody.innerHTML = "";
          data.forEach((emp) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-100 transition";
            tr.innerHTML = `
          <td class="px-4 py-2 border">${formatDateForCSV(emp.hireDate)}</td>
          <td class="px-4 py-2 border">${emp.name || ""}</td>
          <td class="px-4 py-2 border">${emp.nationalId || ""}</td>
          <td class="px-4 py-2 border">${emp.address || ""}</td>
          <td class="px-4 py-2 border">${emp.mobile || ""}</td>
          <td class="px-4 py-2 border">${emp.jobTitle || ""}</td>
          <td class="px-4 py-2 border">${emp.project || ""}</td>
          <td class="px-4 py-2 border">${emp.office || ""}</td>
          <td class="px-4 py-2 border">${emp.status || ""}</td>
          <td class="px-4 py-2 border">${emp.salary || ""}</td>
        `;
            tableBody.appendChild(tr);
          });
        })
        .catch((err) => {
          console.error(err);
          alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงูููุธููู.");
        })
        .finally(() => {
          clearInterval(timer);
          overlay.classList.add("hidden"); // โ ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
        });
    }

    function filterEmployees() {
      const input = document
        .getElementById("searchEmployee")
        .value.trim()
        .toLowerCase();
      const rows = document.querySelectorAll("#employeeTableBody tr");

      rows.forEach((row) => {
        const nameCell = row.querySelector("td:nth-child(2)");
        const nameText = nameCell?.textContent.toLowerCase() || "";
        row.style.display = nameText.includes(input) ? "" : "none";
      });
    }

    function exportEmployeesToExcel() {
      const table = document.querySelector("table");
      const rows = Array.from(table.querySelectorAll("tr"));

      let csvContent = "\uFEFF"; // BOM for UTF-8
      rows.forEach((row) => {
        const cells = Array.from(row.querySelectorAll("th, td")).map(
          (cell) => `="${cell.innerText}"`
        );
        csvContent += cells.join(",") + "\n";
      });

      const blob = new Blob([csvContent], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "employees.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function showStatsPopup() {
      const popup = document.getElementById("statsPopup");
      popup.classList.remove("hidden");

      fetch(
        "https://script.google.com/macros/s/AKfycbwW05ThHhLzFFqq3mZ-hvayRoHlGA7ESpd0ysT1lVPY3nukqr6S5f1WdyHWobGF3c5p/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const total = data.length;
          const married = data.filter(
            (emp) => emp["status"] === "ูุชุฒูุฌ"
          ).length;
          const salaries = data
            .map((emp) => parseFloat(emp["salary"]))
            .filter((s) => !isNaN(s));
          const avgSalary = (
            salaries.reduce((a, b) => a + b, 0) / salaries.length
          ).toFixed(2);

          document.getElementById("totalCount").textContent = total;
          document.getElementById("marriedCount").textContent = married;
          document.getElementById("avgSalary").textContent = avgSalary;

          // ุฑุณู ุจูุงูู
          const ctx = document.getElementById("statsChart").getContext("2d");
          if (window.statsChartInstance) window.statsChartInstance.destroy(); // ูุณุญ ุงููุฏูู
          window.statsChartInstance = new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["ูุชุฒูุฌ", "ุฃุนุฒุจ"],
              datasets: [
                {
                  data: [married, total - married],
                  backgroundColor: ["#6366F1", "#E5E7EB"],
                },
              ],
            },
            options: {
              plugins: { legend: { position: "bottom" } },
            },
          });
        });
    }

    function hideStatsPopup() {
      document.getElementById("statsPopup").classList.add("hidden");
    }

    function downloadStatsPDF() {
      const statsElement = document.getElementById("statsContent");

      html2canvas(statsElement).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, "PNG", 15, 15, 180, 160);
        pdf.save("employee-stats.pdf");
      });
    }

    function showHousingStats() {
      const popup = document.getElementById("housingStatsPopup");
      popup.classList.remove("hidden");

      fetch(
        "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          // ูุณุจุฉ ุญุณุจ ุงูููุชุจ
          const officeCount = {};
          const hondaCount = {};
          const usageTimes = {};

          data.forEach((row) => {
            const office = row["Office"]?.trim();
            const honda = row["PG S.N."]?.trim();
            const type = row["ููุน ุงูุชุณููู"]?.trim();
            const dateTimeStr = row["Date"] + "T" + (row["Time "] || "00:00");

            // ุฅุญุตุงุก ุงูููุงุชุจ
            if (office) officeCount[office] = (officeCount[office] || 0) + 1;

            // ุฅุญุตุงุก ุงููููุฏุง
            if (honda) hondaCount[honda] = (hondaCount[honda] || 0) + 1;

            // ุณุงุนุงุช ุชุดุบูู ุงููููุฏุง (ุจูู ุจุฏุงูุฉ ูููุงูุฉ)
            if (honda && type) {
              if (!usageTimes[honda]) usageTimes[honda] = [];
              usageTimes[honda].push({ type, time: new Date(dateTimeStr) });
            }
          });

          const totalOffices = Object.values(officeCount).reduce(
            (a, b) => a + b,
            0
          );
          const totalHondas = Object.values(hondaCount).reduce(
            (a, b) => a + b,
            0
          );

          const officeLabels = Object.keys(officeCount);
          const officeData = officeLabels.map((key) =>
            ((officeCount[key] / totalOffices) * 100).toFixed(1)
          );

          const hondaLabels = Object.keys(hondaCount);
          const hondaData = hondaLabels.map((key) =>
            ((hondaCount[key] / totalHondas) * 100).toFixed(1)
          );

          const officeCtx = document
            .getElementById("officeChart")
            .getContext("2d");
          const hondaCtx = document
            .getElementById("hondaChart")
            .getContext("2d");

          if (window.officeChartInstance)
            window.officeChartInstance.destroy();
          if (window.hondaChartInstance) window.hondaChartInstance.destroy();

          window.officeChartInstance = new Chart(officeCtx, {
            type: "bar",
            data: {
              labels: officeLabels,
              datasets: [
                {
                  label: "ูุณุจุฉ ุงูุชุณููู ุญุณุจ ุงูููุชุจ",
                  data: officeData,
                  backgroundColor: "#4F46E5",
                },
              ],
            },
            options: { indexAxis: "y", responsive: true },
          });

          window.hondaChartInstance = new Chart(hondaCtx, {
            type: "bar",
            data: {
              labels: hondaLabels,
              datasets: [
                {
                  label: "ูุณุจุฉ ุงุณุชุฎุฏุงู ุงููููุฏุง",
                  data: hondaData,
                  backgroundColor: "#10B981",
                },
              ],
            },
            options: { indexAxis: "y", responsive: true },
          });

          // ุญุณุงุจ ุณุงุนุงุช ุชุดุบูู ุงููููุฏุง
          let totalHours = 0;
          for (const honda in usageTimes) {
            const events = usageTimes[honda].sort((a, b) => a.time - b.time);
            for (let i = 0; i < events.length - 1; i++) {
              if (
                events[i].type === "ุจุฏุงูุฉ" &&
                events[i + 1].type === "ููุงูุฉ"
              ) {
                const diff =
                  (events[i + 1].time - events[i].time) / 1000 / 3600;
                if (diff > 0 && diff < 24) totalHours += diff;
              }
            }
          }
          document.getElementById("totalHondaHours").textContent =
            totalHours.toFixed(1);
        });
    }

    function hideHousingStats() {
      document.getElementById("housingStatsPopup").classList.add("hidden");
    }

    function downloadHousingStatsPDF() {
      const statsElement = document.getElementById("housingStatsContent");
      html2canvas(statsElement).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, "PNG", 15, 15, 180, 160);
        pdf.save("housing-stats.pdf");
      });
    }

    // โ ุฏุงูุฉ ุฅุญุตุงุฆูุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ

    function loadHomeStats() {
      Promise.all([
        fetch(
          "https://script.google.com/macros/s/AKfycbwW05ThHhLzFFqq3mZ-hvayRoHlGA7ESpd0ysT1lVPY3nukqr6S5f1WdyHWobGF3c5p/exec"
        ).then((res) => res.json()),
        fetch(
          "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec"
        ).then((res) => res.json()),
        fetch(
          "https://script.google.com/macros/s/AKfycbw5DZxZYQF-GZ_i3Y7xpazQOtmgVTQTQYohj8Yx5o1lb0Q_zoOYsiSUe-sklkddz4BkWQ/exec"
        )
          .then((res) => res.json())
          .then((data) => (Array.isArray(data) ? data : [])), // โ ุชุญููููุง ูู Array ูู ูุด Array
      ]).then(([employees, housing, store]) => {
        const balances = {
          ุดุจุฑุง: 0,
          ุงููููุฏุณูู: 0,
          "ุฌุณุฑ ุงูุณููุณ": 0,
        };

        store.forEach((row) => {
          const office = row["ุงูููุชุจ"];
          const addition = parseFloat(row["ุงูุฅุถุงูุฉ"] || 0);
          const withdrawal = parseFloat(row["ุงูุตุฑู"] || 0);
          if (balances.hasOwnProperty(office)) {
            balances[office] += addition - withdrawal;
          }
          const totalBalance =
            balances["ุดุจุฑุง"] + balances["ุงููููุฏุณูู"] + balances["ุฌุณุฑ ุงูุณููุณ"];

          if (totalBalance < 7) {
            Swal.fire({
              icon: "warning",
              title: "โ๏ธ ุชูุจูู ูุงู",
              text: "ุฅุฌูุงูู ุฑุตูุฏ ุงููุฎุฒู ุฃูู ูู 7 ูุชุฑ. ูุฑุฌู ุฅุนุงุฏุฉ ุงูุชุนุจุฆุฉ.",
              confirmButtonText: "ูููุช",
            });
          }
        });

        document.getElementById("balanceShubraHome").textContent =
          balances["ุดุจุฑุง"].toFixed(1);
        document.getElementById("balanceMohandessinHome").textContent =
          balances["ุงููููุฏุณูู"].toFixed(1);
        document.getElementById("balanceGesrHome").textContent =
          balances["ุฌุณุฑ ุงูุณููุณ"].toFixed(1);

        document.getElementById("employeeCount").textContent =
          employees.length;
        document.getElementById("lastUpdate").textContent =
          new Date().toLocaleString("ar-EG");

        const realHousings = {};
        const hondaUsage = {};
        const siteUsage = {};
        const officeUsage = {};
        const openHousings = {}; // ๐ ุญุงูุงุช ุงูุชุณููู ุงูููุชูุญุฉ ููุท

        housing.forEach((row) => {
          const name = row["Resource Name"];
          const site = row["Site ID"];
          const honda = row["PG S.N."]?.trim();
          const office = row["Office"]?.trim();

          let typeRaw = row["ููุน ุงูุชุณููู"]?.trim() || "";
          let type = "";
          if (typeRaw.includes("ุจุฏุงูุฉ")) type = "ุจุฏุงูุฉ";
          else if (typeRaw.includes("ููุงูุฉ")) type = "ููุงูุฉ";

          const datetime = new Date(
            `${row["Date"]}T${row["Time "] || "00:00"}`
          );

          const key = `${name}_${site}`;
          if (!realHousings[key]) realHousings[key] = [];
          realHousings[key].push(type);

          if (honda && type) {
            if (!hondaUsage[honda]) hondaUsage[honda] = [];
            hondaUsage[honda].push({ type, time: datetime });
          }

          if (site && type) {
            if (!siteUsage[site]) siteUsage[site] = [];
            siteUsage[site].push(type);
          }

          if (office && type) {
            if (!officeUsage[office]) officeUsage[office] = [];
            officeUsage[office].push(type);
          }

          // โ ุชุฌููุน ุงูุชุณูููุงุช ุงูููุชูุญุฉ
          if (!openHousings[key]) openHousings[key] = [];
          openHousings[key].push({ name, site, type });
        });

        const getRealCount = (arr) => Math.floor((arr?.length || 0) / 2);

        const housingCount = Object.values(realHousings).reduce(
          (sum, arr) => sum + getRealCount(arr),
          0
        );
        document.getElementById("housingCount").textContent = housingCount;

        // โ ุชุตููุฉ ุงูุชุณูููุงุช ุงูููุชูุญุฉ ููุท
        const stillOpen = Object.values(openHousings)
          .filter((arr) => {
            const starts = arr.filter((e) => e.type === "ุจุฏุงูุฉ").length;
            const ends = arr.filter((e) => e.type === "ููุงูุฉ").length;
            return starts > ends;
          })
          .map((arr) => arr.find((e) => e.type === "ุจุฏุงูุฉ"));

        // ๐๏ธ ุนุฑุถ ุนุฏุฏ ุงูุชุณูููุงุช ุงูููุชูุญุฉ
        const openCountDiv = document.getElementById("openHousingCount");
        const openListDiv = document.getElementById("openHousingList");

        if (openCountDiv && openListDiv) {
          openCountDiv.textContent = `ุฅุฌูุงูู ุงูุชุณูููุงุช ุงูููุชูุญุฉ: ${stillOpen.length}`;
          openListDiv.innerHTML = stillOpen
            .map((e) => `<li>โข ${e.site} - ${e.name}</li>`)
            .join("");
        }

        // ๐ ุฑุณู ุจูุงูู ุงุณุชุฎุฏุงู ุงููููุฏุง
        const hondaLabels = Object.keys(hondaUsage);
        const hondaData = hondaLabels.map((key) =>
          getRealCount(hondaUsage[key])
        );
        new Chart(document.getElementById("homeHondaChart"), {
          type: "bar",
          data: {
            labels: hondaLabels,
            datasets: [
              {
                label: "ูุฑุงุช ุงูุชุดุบูู",
                data: hondaData,
                backgroundColor: "#10B981",
              },
            ],
          },
          options: { responsive: true, indexAxis: "y" },
        });

        // ๐ ุฑุณู ุจูุงูู ุชูุฒูุน ุงูููุงุชุจ
        const officeLabels = Object.keys(officeUsage);
        const officeData = officeLabels.map((key) =>
          getRealCount(officeUsage[key])
        );
        new Chart(document.getElementById("homeOfficeChart"), {
          type: "pie",
          data: {
            labels: officeLabels,
            datasets: [
              {
                data: officeData,
                backgroundColor: officeLabels.map(
                  () => `hsl(${Math.random() * 360}, 70%, 70%)`
                ),
              },
            ],
          },
        });

        // ๐ ุชูุฒูุน ุงููุธุงุฆู
        const jobCount = {};
        employees.forEach((emp) => {
          const job = emp["jobTitle"]?.trim();
          if (job) jobCount[job] = (jobCount[job] || 0) + 1;
        });
        const jobLabels = Object.keys(jobCount);
        const jobData = Object.values(jobCount);
        new Chart(document.getElementById("homeJobChart"), {
          type: "bar",
          data: {
            labels: jobLabels,
            datasets: [
              {
                label: "ุนุฏุฏ ุงูููุธููู",
                data: jobData,
                backgroundColor: "#6366f1",
              },
            ],
          },
          options: { responsive: true },
        });

        // ๐ ุชูุฒูุน ุญุณุจ ุงูููุงุชุจ ุงูุฌุงูุจูุฉ
        const officeList = document.getElementById("officeList");
        officeList.innerHTML = ["ุดุจุฑุง", "ุฌุณุฑ ุงูุณููุณ", "ุงููููุฏุณูู"]
          .map((office) => {
            const count = employees.filter(
              (emp) => emp["office"] === office
            ).length;
            return `<li>โข ${office}: ${count} ููุธู</li>`;
          })
          .join("");
        // ๐ ุชุญููู ุฃูุซุฑ ุงูุณูุชุงุช ุชุณููููุง ุญุณุจ ุงูููุชุจ
        const siteOfficeCount = {};
        housing.forEach((row) => {
          const site = row["Site ID"]?.trim();
          const office = row["Office"]?.trim();
          const typeRaw = row["ููุน ุงูุชุณููู"]?.trim();
          const type = typeRaw?.includes("ุจุฏุงูุฉ")
            ? "ุจุฏุงูุฉ"
            : typeRaw?.includes("ููุงูุฉ")
              ? "ููุงูุฉ"
              : "";

          if (site && office && type === "ุจุฏุงูุฉ") {
            const key = `${site}__${office}`;
            siteOfficeCount[key] = (siteOfficeCount[key] || 0) + 1;
          }
        });

        const sortedSites = Object.entries(siteOfficeCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        const siteTable = `
  <h3 class="font-bold text-gray-700 mb-2">๐๏ธ ุฃูุซุฑ ุงูุณูุชุงุช ุชุณููููุง</h3>
  <table class="w-full text-sm border border-gray-300 rounded overflow-hidden">
    <thead class="bg-gray-100 text-gray-700">
      <tr>
        <th class="px-3 py-2 border">Site</th>
        <th class="px-3 py-2 border">ุงูููุชุจ</th>
        <th class="px-3 py-2 border">ุนุฏุฏ ุงูุชุณูููุงุช</th>
      </tr>
    </thead>
    <tbody>
      ${sortedSites
            .map(([key, count]) => {
              const [site, office] = key.split("__");
              return `<tr>
            <td class="px-3 py-2 border">${site}</td>
            <td class="px-3 py-2 border">${office}</td>
            <td class="px-3 py-2 border">${count}</td>
          </tr>`;
            })
            .join("")}
    </tbody>
  </table>
`;

        const container = document.createElement("div");
        container.className = "bg-white p-4 rounded-xl shadow border mt-6";
        container.innerHTML = siteTable;
        document.querySelector("main #mainContent")?.appendChild(container);
      });
    }

    // โ ุชุดุบูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุชููุงุฆููุง ุฃูู ูุง ุงูุตูุญุฉ ุชูุชุญ
    window.addEventListener("DOMContentLoaded", () => {
      loadContent("home");
    });

    // โ ุชุญุฏูุซ ุชููุงุฆู ูู 20 ุซุงููุฉ ูู ุงููุณุชุฎุฏู ูุงูู ุนูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
    setInterval(() => {
      const h2 = document.querySelector("#mainContent h2")?.textContent || "";
      if (h2.includes("๐") || h2.includes("ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ")) {
        console.log("โ ุชู ุงูุชุญุฏูุซ ุงูุชููุงุฆู");
        loadHomeStats();
      }
    }, 20000);

    function extractTimeOnly(dateTimeStr) {
      if (!dateTimeStr) return "";
      try {
        const date = new Date(dateTimeStr);
        return date.toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });
      } catch {
        return dateTimeStr;
      }
    }

    function exportHousingToExcel() {
      const table = document
        .querySelector("#housingTableBody")
        .closest("table");
      const rows = Array.from(table.querySelectorAll("tr"));

      let csvContent = "\uFEFF"; // BOM for UTF-8 ูุชุฏุนู ุงูุนุฑุจู
      rows.forEach((row) => {
        const cells = Array.from(row.querySelectorAll("th, td")).map(
          (cell) => `="${cell.innerText.trim()}"`
        );
        csvContent += cells.join(",") + "\n";
      });

      const blob = new Blob([csvContent], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "housing-data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function showPgRosterCar() {
      const today = new Date();
      const day = today.getDay(); // 0 = ุงูุฃุญุฏ
      const dateStr = today.toISOString().split("T")[0];
      const weekdays = [
        "ุงูุฃุญุฏ",
        "ุงูุงุซููู",
        "ุงูุซูุงุซุงุก",
        "ุงูุฃุฑุจุนุงุก",
        "ุงูุฎููุณ",
        "ุงูุฌูุนุฉ",
        "ุงูุณุจุช",
      ];
      const todayName = weekdays[day];

      const drivers = [
        { name: "ุนุจุฏ ุงูููุตูุฏ", off: 1, office: "ุฌุณุฑ ุงูุณููุณ" },
        { name: "ูุญูุฏ ุญุณูู", off: 3, office: "ุฌุณุฑ ุงูุณููุณ" },
        { name: "ูุญูุฏ ุจูุงู", off: 6, office: "ุฌุณุฑ ุงูุณููุณ" },
        { name: "ุงุจุฑุงููู ุญุณูู", off: 4, office: "ุดุจุฑุง" },
        { name: "ูุญูุฏ ุนุจุฏู", off: 5, office: "ุดุจุฑุง" },
        { name: "ุงุญูุฏ ุนุฒุช", off: 3, office: "ุดุจุฑุง" },
        { name: "ุงุญูุฏ ุนูู", off: 2, office: "ุดุจุฑุง" },
        { name: "ูุงูู ุฑูุงู", off: 1, office: "ุดุจุฑุง" },
        { name: "ุงููู ุฌูุงู", off: 6, office: "ุงููููุฏุณูู" },
        { name: "ุณูุฏ ุฌุงุฏ", off: 0, office: "ุงููููุฏุณูู" },
      ];

      const activeDrivers = drivers.filter((d) => d.off !== day);

      const offices = {
        ุงููููุฏุณูู: [],
        ุดุจุฑุง: [],
        "ุฌุณุฑ ุงูุณููุณ": [],
      };

      activeDrivers.forEach((d) => {
        if (offices[d.office]) {
          offices[d.office].push(d.name);
        }
      });

      const renderSection = (office, names) => `
${office}

โปุดูุช ุงูุตุจุญโป

${names.join("\n")}

โผ ุดูุช ุงูููู โผ

${names.join("\n")}
ูููููููููููููููููููููููููููููููููููููููููููููููููููููููููู`;

      const fullText = `
PG Cars Roster

โป ุดุบู ${todayName} - ${dateStr}

${renderSection("ููุชุจ ุงููููุฏุณูู", offices["ุงููููุฏุณูู"])}
${renderSection("ููุชุจ ุดุจุฑุง", offices["ุดุจุฑุง"])}
${renderSection("ููุชุจ ุงูุฌุณุฑ", offices["ุฌุณุฑ ุงูุณููุณ"])}

๐ป๐บ๐ป๐บ๐ป๐บ๐ป๐บ๐ป๐บ
`;

      const output = document.getElementById("pgRosterOutput");
      document.getElementById("pgRosterWrapper").classList.remove("hidden");
      document.getElementById("pgRosterOutput").innerText = fullText;
      lucide.createIcons(); // ุนูุดุงู ุชุธูุฑ ุงูุฃููููุงุช ุจุนุฏ ุฅุฏุฎุงููุง ุฏููุงูููููุง
    }

    function copyPgRosterText() {
      const text = document.getElementById("pgRosterOutput")?.innerText || "";
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          Swal.fire({
            icon: "success",
            title: "ุชู ุงููุณุฎ",
            text: "ุชู ูุณุฎ ูุงุฆูุฉ ุงูุณุงุฆููู!",
            timer: 1500,
            showConfirmButton: false,
          });
        });
      }
    }

    function hidePgRosterOutput() {
      document.getElementById("pgRosterWrapper").classList.add("hidden");
    }

    function submitStoreForm(event) {
      event.preventDefault();
      const date = document.getElementById("storeDate").value;
      const office = document.getElementById("storeOffice").value.trim();
      const qty = document.getElementById("storeQty").value.trim();
      const serial = document.getElementById("storeSerial").value.trim();

      const payload = {
        date,
        office,
        qty,
        serial,
      };

      fetch("https://script.google.com/macros/s/YOUR_SCRIPT_URL_HERE/exec", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" },
      })
        .then((res) => res.json())
        .then((res) => {
          Swal.fire({
            icon: "success",
            title: "โ ุชู ุงูุฅุฑุณุงู",
            text: "ุชู ุฅุถุงูุฉ ุจูุงูุงุช ุงูููุชุฌ ุจูุฌุงุญ",
            timer: 2000,
            showConfirmButton: false,
          });
          document.getElementById("storeDate").value = "";
          document.getElementById("storeOffice").value = "";
          document.getElementById("storeQty").value = "";
          document.getElementById("storeSerial").value = "";
        })
        .catch((err) => {
          Swal.fire({
            icon: "error",
            title: "โ ุฎุทุฃ",
            text: "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุจูุงูุงุช",
          });
          console.error(err);
        });
    }

    function openStorePopup() {
      document.getElementById("storePopup").classList.remove("hidden");
      document.getElementById("popupType").value = "ุฅุถุงูุฉ";
      updatePopupButton();
    }

    function closeStorePopup() {
      document.getElementById("storePopup").classList.add("hidden");
    }

    function updatePopupButton() {
      const type = document.getElementById("popupType").value;
      const btn = document.getElementById("popupSubmitBtn");
      btn.textContent = type === "ุตุฑู" ? "ุชูููุฐ ุงูุตุฑู" : "ุชูููุฐ ุงูุฅุถุงูุฉ";
    }

    // โ๏ธ ูุฐู ุงูุฏุงูุฉ ุณุชุฑุณู ุงูุจูุงูุงุช ูุงุญููุง ุฅูู Google Sheet (ุณูููููุง ูู ุงูุฎุทูุฉ ุงููุงุฏูุฉ)
    function submitStoreEntry() {
      const fields = {
        date: document.getElementById("popupDate").value,
        technician: document.getElementById("popupTechnician").value.trim(),
        office: document.getElementById("popupOffice").value,
        qty: parseFloat(document.getElementById("popupQty").value || 0),
        type: document.getElementById("popupType").value,
        serial: document.getElementById("popupSerial").value,
        addition:
          document.getElementById("popupType").value === "ุฅุถุงูุฉ"
            ? parseFloat(document.getElementById("popupQty").value || 0)
            : "",
        withdrawal:
          document.getElementById("popupType").value === "ุตุฑู"
            ? parseFloat(document.getElementById("popupQty").value || 0)
            : "",
      };

      // ุฅุฑุณุงู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู fetch
      const formData = new URLSearchParams();
      for (const key in fields) {
        formData.append(key, fields[key]);
      }

      fetch(
        "https://script.google.com/macros/s/AKfycbyNNJGhxomTdYVxstv4pUDBzvFVn7oTAtkCbeQfPE09exvUTmnhQUWAWPrNN4t1TGan4Q/exec",
        {
          method: "POST",
          body: formData,
        }
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            Swal.fire({
              icon: "success",
              title: "โ ุชู ุงูุญูุธ",
              text: "ุชู ุชุณุฌูู ุงูุนูููุฉ ุจูุฌุงุญ",
              timer: 1500,
              showConfirmButton: false,
            });
            closeStorePopup(); // ูููู ุงูุจูุจ-ุฃุจ
            fetchStoreData(); // ูุญุฏุซ ุงูุฌุฏูู ุจุนุฏ ุงูุนูููุฉ
          } else {
            Swal.fire({
              icon: "error",
              title: "โ ุฎุทุฃ",
              text: "ูุดู ูู ุฅุฑุณุงู ุงูุจูุงูุงุช",
            });
          }
        })
        .catch((err) => {
          Swal.fire({
            icon: "error",
            title: "โ ุฎุทุฃ",
            text: "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฎุงุฏู",
          });
          console.error(err);
        });
    }

    function fetchStoreData() {
      fetch(
        "https://script.google.com/macros/s/AKfycbw5DZxZYQF-GZ_i3Y7xpazQOtmgVTQTQYohj8Yx5o1lb0Q_zoOYsiSUe-sklkddz4BkWQ/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          storeDataCache = data; // โฌ๏ธ ูุฎุฒู ุงูุจูุงูุงุช ูุคูุชูุง
          renderFilteredStoreData(); // โฌ๏ธ ูุนุฑุถ ุจุงุณุชุฎุฏุงู ุงูููุชุฑ
        })
        .catch((err) => {
          console.error("โ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช:", err);
          Swal.fire("โ๏ธ ูู ูุชู ุชุญููู ุจูุงูุงุช ุงููุฎุฒู");
        });
    }

    function formatDateOnlyEgypt(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-US", {
        timeZone: "Africa/Cairo", // ุชูููุช ูุตุฑ
        weekday: "long", // Friday
        year: "numeric", // 2025
        month: "long", // June
        day: "2-digit", // 27
      });
    }

    function renderFilteredStoreData() {
      const tbody = document.getElementById("storeTableBody");
      tbody.innerHTML = "";

      const filterType = document.getElementById("filterType").value;
      const filterOffice = document.getElementById("filterOffice").value;

      const balances = {
        ุดุจุฑุง: 0,
        ุงููููุฏุณูู: 0,
        "ุฌุณุฑ ุงูุณููุณ": 0,
      };

      const filteredData = storeDataCache.filter((row) => {
        const matchesType = !filterType || row["ููุน ุงูุนูููุฉ"] === filterType;
        const matchesOffice = !filterOffice || row["ุงูููุชุจ"] === filterOffice;
        return matchesType && matchesOffice;
      });

      filteredData.forEach((row) => {
        const addition = parseFloat(row["ุงูุฅุถุงูุฉ"] || 0);
        const withdrawal = parseFloat(row["ุงูุตุฑู"] || 0);
        const office = row["ุงูููุชุจ"];

        if (balances.hasOwnProperty(office)) {
          balances[office] += addition - withdrawal;
        }

        const tr = document.createElement("tr");

        if (row["ููุน ุงูุนูููุฉ"] === "ุฅุถุงูุฉ") {
          tr.className = "bg-green-50 hover:bg-green-100";
        } else if (row["ููุน ุงูุนูููุฉ"] === "ุตุฑู") {
          tr.className = "bg-red-50 hover:bg-red-100";
        } else {
          tr.className = "hover:bg-gray-50";
        }

        tr.innerHTML = `
      <td class="px-4 py-2 border">${formatDateOnlyEgypt(row["ุงูุชุงุฑูุฎ"])}</td>
      <td class="px-4 py-2 border">${row["ุงุณู ุงูููู"]}</td>
      <td class="px-4 py-2 border">${office}</td>
      <td class="px-4 py-2 border">${row["ุงููููุฉ"]}</td>
      <td class="px-4 py-2 border">${row["ููุน ุงูุนูููุฉ"]}</td>
      <td class="px-4 py-2 border">${row["ุงูุฑูู ุงูุชุณูุณูู"]}</td>
      <td class="px-4 py-2 border">${row["ุงูุฅุถุงูุฉ"] || ""}</td>
      <td class="px-4 py-2 border">${row["ุงูุตุฑู"] || ""}</td>
    `;
        tbody.appendChild(tr);
      });

      // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูููุงุชุจ
      document.getElementById("balanceShubra").textContent = balances["ุดุจุฑุง"];
      document.getElementById("balanceMohandessin").textContent =
        balances["ุงููููุฏุณูู"];
      document.getElementById("balanceGesr").textContent =
        balances["ุฌุณุฑ ุงูุณููุณ"];

      // ๐ป ููุง ุชุจุฏุฃ ููุฏ ุงูุชูุจูู
      const totalBalance =
        balances["ุดุจุฑุง"] + balances["ุงููููุฏุณูู"] + balances["ุฌุณุฑ ุงูุณููุณ"];

      if (totalBalance < 7) {
        Swal.fire({
          icon: "warning",
          title: "โ๏ธ ุชูุจูู ูุงู",
          text: "ุฅุฌูุงูู ุฑุตูุฏ ุงููุฎุฒู ุฃูู ูู 7 ูุชุฑ. ูุฑุฌู ุฅุนุงุฏุฉ ุงูุชุนุจุฆุฉ.",
          confirmButtonText: "ูููุช",
        });
      }
    }
    function exportAllStoreData() {
      if (!storeDataCache.length) {
        Swal.fire("โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุงููุงู ููุชุตุฏูุฑ.");
        return;
      }

      const headers = [
        "ุงูุชุงุฑูุฎ",
        "ุงุณู ุงูููู",
        "ุงูููุชุจ",
        "ุงููููุฉ",
        "ููุน ุงูุนูููุฉ",
        "ุงูุฑูู ุงูุชุณูุณูู",
        "ุงูุฅุถุงูุฉ",
        "ุงูุตุฑู",
      ];

      const rows = storeDataCache.map((row) => [
        formatDateForCSV(row["ุงูุชุงุฑูุฎ"]),
        row["ุงุณู ุงูููู"],
        row["ุงูููุชุจ"],
        row["ุงููููุฉ"],
        row["ููุน ุงูุนูููุฉ"],
        row["ุงูุฑูู ุงูุชุณูุณูู"],
        row["ุงูุฅุถุงูุฉ"] || "",
        row["ุงูุตุฑู"] || "",
      ]);

      let csvContent = "\uFEFF" + headers.join(",") + "\n"; // BOM ูุฏุนู ุงูุนุฑุจู

      rows.forEach((row) => {
        csvContent += row.join(",") + "\n";
      });

      const blob = new Blob([csvContent], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "ุฌููุน_ุจูุงูุงุช_ุงููุฎุฒู.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function formatDateForCSV(isoDateString) {
      const date = new Date(isoDateString);
      return date.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        timeZone: "Africa/Cairo",
      }); // ุงููุชูุฌุฉ: 27/06/2025
    }
  </script>
</body>

</html>
